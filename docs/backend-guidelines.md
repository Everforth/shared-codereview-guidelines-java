## レビュープロセス（必須手順）

### STEP 0: PR の理解

**【開始条件】レビューを開始する前に必ず実施**

0. **プロジェクト固有設定の確認（存在する場合のみ）**
   - `@/CLAUDE.md`: プロジェクト固有のAI向け指示・制約を確認
   - `@/AGENTS.md`: エージェント固有の設定・ガイドラインを確認

1. **PR Description の精読**
   - 「なぜやるか」: 解決しようとしている課題を理解
   - 「やったこと」: 実装内容の概要を把握
   - 「確認したいこと」: レビュアーへの質問事項を確認
2. **変更の影響範囲の把握**
   - 変更されたファイル一覧を確認
   - 新規追加 vs 既存修正 を区別
   - API仕様変更やDB変更の有無を確認

### STEP 1: 次のレビュー対象層の決定

現在のレビュー進捗を確認し、次にレビューすべき1つの層のみを決定してください。
他の層のコードは一切確認しないでください。

【AI Agent層の判定】

レビュー開始時、以下のファイルパターンに変更があるか確認する:

- `*AgentService.java`
- `*-agent/*.java`
- `*/agents/*.java`
- Tool定義ファイル（`**/tools/**`）

該当ファイルがある場合、AI Agent層を最初にレビューする。

【レビュー対象層】

0. AI Agent層（Agent実装、ツール定義、型定義 等）※該当ファイルがある場合のみ
   - Agent実装パターンの遵守、FunctionCallResultの設計、additionalDataの管理

1. DB層（Entity定義, 型定義, スキーマ定義 等）
   - データモデルの整合性、制約・インデックスの適切性、型定義の一貫性

2. Controller層（エンドポイント、リクエスト/レスポンス処理、DTO 等）
   - エンドポイント設計、バリデーション・エラーハンドリング、HTTPステータスコード

3. Service層（ビジネスロジック、データ処理 等）
   - ビジネスロジックの正確性、トランザクション境界の適切性、データ変換処理

4. その他（テストコード, 設定ファイル 等）

【レビュー順序】

- 0層目: AI Agent層（該当ファイルがある場合のみ）
- 1層目: DB層
- 2層目: Controller層
- 3層目: Service層
- 4層目: その他

【完了条件】次にレビューする層を明記してください → 【　　　】層

### STEP 2: ガイドライン確認

【開始条件】STEP 1で次のレビュー対象層を決定済みであること

STEP 1で決定した層に対応するガイドラインを確認してください。
該当する1つのガイドラインのみ参照し、他の層のガイドラインは開かないでください。

- AI Agent層を特定した場合のみ: @shared-codereview-guidelines/docs/backend-layers/A_ai_agent.md
  - 実装パターンからの逸脱は修正必須とする
- DB層を特定した場合のみ: @shared-codereview-guidelines/docs/backend-layers/1_db.md
- Controller層を特定した場合のみ: @shared-codereview-guidelines/docs/backend-layers/2_controller.md
- Service層を特定した場合のみ: @shared-codereview-guidelines/docs/backend-layers/3_service.md
- その他を特定した場合のみ: @shared-codereview-guidelines/docs/backend-layers/4_other.md
- Enum関連の変更がある場合: @shared-codereview-guidelines/docs/backend-layers/B_Enum定義.md も併せて確認
  - 二層定義パターンに従っているか（Db型と現役仕様型の分離）
  - DTOやService層で現役仕様型を使用しているか
  - Entity定義でDb型を使用しているか
  - enumNameが明示的に指定されているか
  - migrationが手書きで、適切なALTER TYPE文を使用しているか
  - deprecated値にコメントが付いているか
  - ORMの自動生成migrationでenumが変更されていないか

### STEP 3: 1層のみレビュー実施

**【開始条件】**

- STEP 1で次のレビュー対象層を決定済みであること
- STEP 2で該当するガイドラインを確認済みであること

**【実施内容】**

STEP 1で決定した1つの層のみをレビューしてください。
他の層については一切言及しないでください。
必ず既存コードや関連コードと比較し、一貫性を保つようにしてください。
レビューする際はガイドラインまたは既存コードの具体的なファイル名を明示してください。

**【レビュー後の処理】**

各層のレビュー完了後、必ず以下を実施：

1. 該当層のレビュー結果を出力
2. 現在のレビュー状況を明記（後述のフォーマット使用）
3. 問題がない場合のみ：STEP 1に戻り次の層へ進む
4. 問題がある場合：即座に停止し、修正を待つ

**【レビュー結果の記載形式】**

レビュー結果は必ず以下の形式で出力してください:

#### 🔴 修正必須（マージブロッカー）

- バグや不具合
- セキュリティリスク
- 仕様との明確な不一致
- 既存コードとの破壊的な非互換性
- レビューガイドラインとの明確な不一致

以下は修正必須に該当しない:

- 代替設計の提案（別パターンの方が良いのでは、という提案）
- 確認なしの推測に基づく指摘（グローバル設定や既存規約を確認せずに行う指摘）

#### 🟡 修正推奨（今回または次回対応）

- 保守性・拡張性の明確な改善
- パフォーマンスの測定可能な向上

**【各層レビュー後の記載（必須）】**

各層のレビューが完了するたびに、必ず現在のレビュー状況を以下の形式で明記してください：

```
## レビュー状況
- ✅ AI Agent層: レビュー完了（または「該当なし」）
- ✅ DB層: レビュー完了
- ✅ Controller層: レビュー完了
- ✅ Service層: レビュー完了
- ✅ その他: レビュー完了
```

問題を発見して途中で停止した場合:

```
## レビュー状況
- ✅ AI Agent層: 該当なし
- ✅ DB層: レビュー完了
- 🔴 Controller層: 修正必須項目あり（レビュー停止）
- ⏸️ Service層: 未実施
- ⏸️ その他: 未実施
```

**【レビューを中止する場合】**

ユーザーからレビュー中止の指示があった場合、一旦レビューを完了として扱い、現在までのレビュー状況のメッセージを更新してください。

### 禁止事項

1. 一度に複数の層をレビューすることの禁止
   - 必ず1層ずつレビューを実施
   - 各層のレビュー後に必ずレビュー状況を報告
   - 現在レビュー中の層以外のコードに言及しない
   - 他の層で気づいた問題があっても、現在の層のレビューが完了するまで言及しない

2. 総評・まとめ・良い点の言及は不要
   - 「総評」「総合評価」「まとめ」「全体として」「技術的評価」などのセクションを作成しない
   - 「〜が良いです」「〜は適切です」などのポジティブな評価を記載しない
   - レビュー結果の形式（🔴修正必須、🟡修正推奨）は問題点の整理であり、総評ではないため使用する

3. レビューサイクルの厳守
   - 「1層レビュー → 結果報告 → レビュー状況明記」のサイクルを必ず守る
   - 🔴修正必須・🟡修正推奨がない場合のみ、STEP 1に戻って次の層へ
   - 問題を発見した時点で即座に停止

### レビュー観点

#### 基本原則

- コードの可読性と保守性を最優先
- 既存コードとの命名・パターンの一貫性を確認する
- PRの説明文やIssueの内容と実装に違和感がある場合、意図を確認するためにユーザーに質問すること
- 命名規則に関する指摘は、同種の既存ファイルを確認してから行う
- PRスコープ: 関係のないファイルへの変更が混入していないか確認する
